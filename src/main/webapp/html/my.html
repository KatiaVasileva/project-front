<html lang="en">
<head>
    <title>RPG</title>
    <link rel="stylesheet" href="/css/my.css">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
</head>

<body>
<h1>RPG admin panel</h1>
<h2>Accounts List</h2>
<div class="select-container">
    <label for="items-per-page" id="label-for-page-count">Count per page:</label>
    <select id="items-per-page">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</div>

<table id="main-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<div class="pgn-container">
    <p class="pgn-text"> Pages:</p>
    <div id="pgn">
    </div>
</div>

<script>
    let currentPage = 0;
    let currentPageSize = 3;
    let currentTotalPages = 0;

    const RACES = ['HUMAN','DWARF','ELF','GIANT','ORC','TROLL','HOBBIT'];
    const PROFESSIONS = ['WARRIOR','ROGUE','SORCERER','CLERIC','PALADIN','NAZGUL','WARLOCK','DRUID'];

    function loadPlayers(pageNumber, pageSize) {
        currentPage = pageNumber;
        currentPageSize = pageSize;

        $.get('/rest/players', {pageNumber: pageNumber, pageSize: pageSize})
            .done(function (players) {
                const $tbody = $('#main-table tbody');
                $tbody.empty();

                if (players.length === 0) {
                    $tbody.append('<tr><td colspan="10">Нет игроков</td></tr>');
                    return;
                }

                players.forEach(function (player) {
                    const $tr = $('<tr>').attr('id', `player-${player.id}`);
                    $tr.append($('<td>').text(player.id));
                    $tr.append($('<td>').text(player.name));
                    $tr.append($('<td>').text(player.title));
                    $tr.append($('<td>').text(player.race));
                    $tr.append($('<td>').text(player.profession));
                    $tr.append($('<td>').text(player.level));
                    $tr.append($('<td>').text(new Date(player.birthday).toLocaleDateString()));
                    $tr.append($('<td>').text(player.banned ? 'Yes' : 'No'));

                    const $editBtn = $('<td>').addClass('table-img');
                    $editBtn.append($('<img>').attr({
                        src: '/img/edit.png',
                        alt: 'edit',
                        class: 'icon edit-icon',
                        'data-player-id': player.id,
                        'data-action': 'edit'
                    }));
                    $tr.append($editBtn);

                    const $deleteBtn = $('<td>').addClass('table-img');
                    $deleteBtn.append($('<img>').attr({
                        src: '/img/delete.png',
                        alt: 'delete',
                        class: 'icon delete-icon',
                        'data-player-id': player.id,
                        'data-action': 'delete'
                    }));
                    $tr.append($deleteBtn);

                    $tbody.append($tr);
                });
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when loading players:', textStatus, errorThrown);
                alert('Failed to load data from server.');
            });
    }

    $('#main-table')
        .on('click', '.edit-icon', function () {
            const $btn = $(this);
            const $row = $btn.closest('tr');
            const action = $btn.data('action');

            if (action === 'edit') {
                enableEditMode($row);
            } else if (action === 'save') {
                savePlayer($row);
            }
        })
        .on('click', '.delete-icon', function () {
        const playerId = $(this).data('player-id');
        deletePlayer(playerId, currentPage);
    })

    $(document).ready(function () {
        const $itemsPerPage = $('#items-per-page');

        $itemsPerPage.val(currentPageSize);
        loadPlayers(0, currentPageSize);
        renderPagination(currentPageSize);

        $itemsPerPage.on('change', function () {
            currentPageSize = +this.value;
            loadPlayers(0, currentPageSize);
            renderPagination(currentPageSize);
        });
    });

    function getTotalCount() {
        return $.get('rest/players/count')
            .then(function (count) {
                return count;
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when getting total number of accounts', textStatus, errorThrown);
                alert('Failed to get total number of accounts');
                return 0;
            });
    }

    function renderPagination(pageSize) {
        getTotalCount().then(function (totalCount) {
            const totalPages = Math.ceil(totalCount / pageSize);
            currentTotalPages = totalPages;
            const $pagination = $('#pgn');
            $pagination.empty();

            for (let i = 1; i <= totalPages; i++) {
                $('.page-btn[data-page="1"]').addClass('active');
                const button = `<button class="page-btn" data-page="${i}">${i}</button>`;
                $pagination.append(button);
            }

            $('.page-btn[data-page="' + (currentPage + 1) + '"]').addClass('active');

            $('.page-btn').click(function () {
                const page = $(this).data('page');
                loadPlayers(page - 1, pageSize);
                $('.page-btn').removeClass('active');
                $(this).addClass('active');
            })
        })
    }

    function savePlayer($row) {
        const id = $row.attr('id').split('-')[1];

        const updatedPlayer = {
            id,
            name: $row.find('td:eq(1) input').val(),
            title: $row.find('td:eq(2) input').val(),
            race: $row.find('td:eq(3) select').val(),
            profession: $row.find('td:eq(4) select').val(),
            banned: $row.find('td:eq(7) select').val() === 'true'
        };

        $.ajax({
            url: `/rest/players/${id}`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updatedPlayer),
            success: function () {
                console.log(`Player ID=${id} is updated`);
                loadPlayers(currentPage, currentPageSize)
            }
        });
    }

    function deletePlayer(playerId) {
        $.ajax({
            url: `/rest/players/${playerId}`,
            type: 'DELETE',
            success: function () {
                console.log(`Player ID = ${playerId} is deleted`);
                loadPlayers(currentPage, currentPageSize);
                getTotalCount().then(function (totalCount) {
                    const totalPages = Math.ceil(totalCount / currentPageSize);
                    if (totalPages < currentTotalPages) {
                        loadPlayers(currentPage - 1, currentPageSize);
                        renderPagination(currentPageSize);
                    }
                })
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error when deleting player: ', textStatus, errorThrown);
                alert('Failed to delete the player.');
            }
        })
    }

    function enableEditMode($row) {
        if ($row.data('editing')) return;

        $row.data('editing', true);
        $row.find('.delete-icon').hide();

        const $btn = $row.find('.edit-icon');
        $btn
            .attr('src', '/img/save.png')
            .attr('alt', 'save')
            .data('action', 'save');

        $row.find('td:eq(1)').html(`<input value="${$row.find('td:eq(1)').text()}" class="edit-field">`);
        $row.find('td:eq(2)').html(`<input value="${$row.find('td:eq(2)').text()}" class="edit-field">`);

        $row.find('td:eq(3)').html(makeSelect(RACES, $row.find('td:eq(3)').text()));
        $row.find('td:eq(4)').html(makeSelect(PROFESSIONS, $row.find('td:eq(4)').text()));

        const banned = $row.find('td:eq(7)').text() === 'Yes';
        $row.find('td:eq(7)').html(`
        <select class="edit-field">
            <option value="false" ${!banned ? 'selected' : ''}>No</option>
            <option value="true" ${banned ? 'selected' : ''}>Yes</option>
        </select>`);
    }

    function makeSelect(options, selected) {
        return `
        <select class="edit-field">
            ${options.map(o =>
            `<option ${o === selected ? 'selected' : ''}>${o}</option>`
        ).join('')}
        </select>`;
    }

</script>

</body>
</html>