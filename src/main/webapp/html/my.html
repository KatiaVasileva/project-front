<html lang="en">
<head>
    <title>RPG</title>
    <link rel="stylesheet" href="/css/my.css">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
</head>

<body>
<h1>RPG admin panel</h1>
<h2>Accounts List</h2>
<div class="select-container">
    <label for="items-per-page" id="label-for-page-count">Count per page:</label>
    <select id="items-per-page">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</div>

<table id="main-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<div class="pgn-container">
    <p class="pgn-text"> Pages:</p>
    <div id="pgn">
    </div>
</div>

<hr>

<h2>Create new account:</h2>

<form id="create-player-form">
    <div class="create-player-field">
        <label for="create-name">Name:</label>
        <input type="text" id="create-name" maxlength="12">
    </div>

    <div class="create-player-field">
        <label for="create-title">Title:</label>
        <input type="text" id="create-title" maxlength="30">
    </div>

    <div class="create-player-field">
        <label for="create-race">Race:</label>
        <select id="create-race"></select>
    </div>

    <div class="create-player-field">
        <label for="create-profession">Profession:</label>
        <select id="create-profession"></select>
    </div>

    <div class="create-player-field">
        <label for="create-level">Level:</label>
        <input type="number" id="create-level" min="0" max="100" placeholder="0">
    </div>

    <div class="create-player-field">
        <label for="create-birthday">Birthday:</label>
        <input type="date" id="create-birthday" min="1900-01-01" max="2025-01-01">
    </div>

    <div class="create-player-field">
        <label for="create-banned">Banned:</label>
        <select id="create-banned">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </select>
    </div>

    <button type="button" id="create-player-btn">Save</button>

    <div id="create-error" class="error-message"></div>
</form>

<script>
    let currentPage = 0;
    let currentPageSize = 3;

    const RACES = ['HUMAN', 'DWARF', 'ELF', 'GIANT', 'ORC', 'TROLL', 'HOBBIT'];
    const PROFESSIONS = ['WARRIOR', 'ROGUE', 'SORCERER', 'CLERIC', 'PALADIN', 'NAZGUL', 'WARLOCK', 'DRUID'];

    $(document).ready(function () {
        fillSelect('#create-race', RACES);
        fillSelect('#create-profession', PROFESSIONS);

        const $itemsPerPage = $('#items-per-page');

        $itemsPerPage.val(currentPageSize);
        loadPlayers(0, currentPageSize);
        renderPagination(currentPageSize);

        $itemsPerPage.on('change', function () {
            currentPageSize = +this.value;
            loadPlayers(0, currentPageSize);
            renderPagination(currentPageSize);
        });
    });

    function loadPlayers(pageNumber, pageSize) {
        currentPage = pageNumber;
        currentPageSize = pageSize;

        clearCreateError();

        $.get('/rest/players', {pageNumber: pageNumber, pageSize: pageSize})
            .done(function (players) {
                const $tbody = $('#main-table tbody');
                $tbody.empty();

                if (players.length === 0) {
                    $tbody.append('<tr><td colspan="10">Нет игроков</td></tr>');
                    return;
                }

                players.forEach(function (player) {
                    const $tr = $('<tr>').attr('id', `player-${player.id}`);
                    $tr.append($('<td>').text(player.id));
                    $tr.append($('<td>').text(player.name));
                    $tr.append($('<td>').text(player.title));
                    $tr.append($('<td>').text(player.race));
                    $tr.append($('<td>').text(player.profession));
                    $tr.append($('<td>').text(player.level));
                    $tr.append($('<td>').text(new Date(player.birthday).toLocaleDateString()));
                    $tr.append($('<td>').text(player.banned ? 'Yes' : 'No'));

                    const $editBtn = $('<td>').addClass('table-img');
                    $editBtn.append($('<img>').attr({
                        src: '/img/edit.png',
                        alt: 'edit',
                        class: 'icon edit-icon',
                        'data-player-id': player.id,
                        'data-action': 'edit'
                    }));
                    $tr.append($editBtn);

                    const $deleteBtn = $('<td>').addClass('table-img');
                    $deleteBtn.append($('<img>').attr({
                        src: '/img/delete.png',
                        alt: 'delete',
                        class: 'icon delete-icon',
                        'data-player-id': player.id,
                        'data-action': 'delete'
                    }));
                    $tr.append($deleteBtn);

                    $tbody.append($tr);
                });
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when loading players:', textStatus, errorThrown);
                alert('Failed to load data from server.');
            });
    }

    function getTotalCount() {
        return $.get('rest/players/count')
            .then(function (count) {
                return count;
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when getting total number of accounts', textStatus, errorThrown);
                alert('Failed to get total number of accounts');
                return 0;
            });
    }

    function renderPagination(pageSize) {
        getTotalCount().then(function (totalCount) {
            const totalPages = Math.ceil(totalCount / pageSize);
            const $pagination = $('#pgn').empty();

            for (let i = 1; i <= totalPages; i++) {
                $('.page-btn[data-page="1"]').addClass('active');
                $pagination.append(`<button class="page-btn" data-page="${i}">${i}</button>`);
            }

            $('.page-btn')
                .removeClass('active')
                .filter(`[data-page="${currentPage + 1}"]`)
                .addClass('active');
        })
    }

    $('#pgn')
        .on('click', '.page-btn', function () {
            currentPage = $(this).data('page') - 1;
            loadPlayers(currentPage, currentPageSize);
            $('.page-btn').removeClass('active');
            $(this).addClass('active');
        });

    $('#main-table')
        .on('click', '.edit-icon', function () {
            const $btn = $(this);
            const $row = $btn.closest('tr');
            const action = $btn.data('action');

            if (action === 'edit') {
                enableEditMode($row);
            } else if (action === 'save') {
                savePlayer($row);
            }
        })
        .on('click', '.delete-icon', function () {
            const playerId = $(this).data('player-id');
            deletePlayer(playerId, currentPage);
        })

    function enableEditMode($row) {
        if ($row.data('editing')) return;

        $row.data('editing', true);
        $row.find('.delete-icon').hide();

        const $btn = $row.find('.edit-icon');
        $btn
            .attr('src', '/img/save.png')
            .attr('alt', 'save')
            .data('action', 'save');

        $row.find('td:eq(1)').html(`<input value="${$row.find('td:eq(1)').text()}" class="edit-field">`);
        $row.find('td:eq(2)').html(`<input value="${$row.find('td:eq(2)').text()}" class="edit-field">`);

        $row.find('td:eq(3)').html(makeSelect(RACES, $row.find('td:eq(3)').text()));
        $row.find('td:eq(4)').html(makeSelect(PROFESSIONS, $row.find('td:eq(4)').text()));

        const banned = $row.find('td:eq(7)').text() === 'Yes';
        $row.find('td:eq(7)').html(`
        <select class="edit-field">
            <option value="false" ${!banned ? 'selected' : ''}>No</option>
            <option value="true" ${banned ? 'selected' : ''}>Yes</option>
        </select>`);
    }

    $('#create-player-btn').on('click', function () {
        clearInvalid();
        clearCreateError();

        const name = $('#create-name').val().trim();
        const title = $('#create-title').val().trim();
        const race = $('#create-race').val();
        const profession = $('#create-profession').val();
        const level = Number($('#create-level').val());
        const birthdayStr = $('#create-birthday').val();
        const birthday = new Date(birthdayStr).getTime();
        const banned = $('#create-banned').val() === 'true';

        let hasError = false;

        if (!name || name.length > 12) {
            markInvalid('#create-name');
            hasError = true;
        }

        if (!title || title.length > 30) {
            markInvalid('#create-title');
            hasError = true;
        }

        if (isNaN(level) || level < 0 || level > 100) {
            markInvalid('#create-level');
            hasError = true;
        }

        if (!birthdayStr || isNaN(birthday) || birthday < 0) {
            markInvalid('#create-birthday');
            hasError = true;
        }

        if (hasError) {
            showCreateError('Please correct highlighted fields');
            return;
        }

        const newPlayer = {
            name,
            title,
            race,
            profession,
            level,
            birthday,
            banned
        };

        $.ajax({
            url: '/rest/players',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newPlayer),
            success: function () {
                getTotalCount().then(function (totalCount) {
                    console.log(`Player is created`);
                    const totalPages = Math.ceil(totalCount / currentPageSize);
                    currentPage = totalPages > 0 ? totalPages - 1 : 0;
                    loadPlayers(currentPage, currentPageSize);
                    renderPagination(currentPageSize);
                    alert('Player is successfully created');
                });
                clearCreateForm();
                clearCreateError();
            },
            error: function (xhr) {
                let message = 'Failed to create player';
                if (xhr.status === 400 && xhr.responseText) {
                    message = xhr.responseText;
                }
                showCreateError(message);
            }
        })
    });

    const $createForm = $('#create-player-form');

    $createForm
        .on('input change', 'input, select', function () {
            $(this).removeClass('invalid');
            clearCreateError();
        });

    function savePlayer($row) {
        const id = $row.attr('id').split('-')[1];

        const updatedPlayer = {
            id,
            name: $row.find('td:eq(1) input').val(),
            title: $row.find('td:eq(2) input').val(),
            race: $row.find('td:eq(3) select').val(),
            profession: $row.find('td:eq(4) select').val(),
            banned: $row.find('td:eq(7) select').val() === 'true'
        };

        $.ajax({
            url: `/rest/players/${id}`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updatedPlayer),
            success: function () {
                console.log(`Player ID=${id} is updated`);
                $row.removeData('editing');
                loadPlayers(currentPage, currentPageSize)
            }
        });
    }

    function deletePlayer(playerId) {
        $.ajax({
            url: `/rest/players/${playerId}`,
            type: 'DELETE',
            success: function () {
                getTotalCount().then(function (totalCount) {
                    const newTotalPages = Math.ceil(totalCount / currentPageSize);
                    if (newTotalPages === 0) {
                        currentPage = 0;
                    } else if (currentPage >= newTotalPages) {
                        currentPage = newTotalPages - 1;
                    }
                    console.log(`Player ID = ${playerId} is deleted`);
                    loadPlayers(currentPage, currentPageSize);
                    renderPagination(currentPageSize);
                })
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error when deleting player: ', textStatus, errorThrown);
                alert('Failed to delete the player.');
            }
        })
    }

    function makeSelect(options, selected) {
        return `
        <select class="edit-field">
            ${options.map(o =>
            `<option ${o === selected ? 'selected' : ''}>${o}</option>`
        ).join('')}
        </select>`;
    }

    function fillSelect(selector, values) {
        const $select = $(selector);
        values.forEach(v => $select.append(`<option value="${v}">${v}</option>`));
    }

    function clearCreateForm() {
        $('#create-player-form input').val('');
        $('#create-banned').val('false');
    }

    function showCreateError(message) {
        $('#create-error')
            .text(message)
            .show();
    }

    function clearCreateError() {
        $('#create-error')
            .hide()
            .text('');
    }

    function markInvalid(selector) {
        $(selector).addClass('invalid');
    }

    function clearInvalid() {
        $('#create-player-form input, #create-player-form select')
            .removeClass('invalid');
    }

</script>

</body>
</html>