<html lang="en">
<head>
    <title>RPG</title>
    <link rel="stylesheet" href="/css/my.css">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
</head>

<body>
<h1>RPG admin panel</h1>
<h2>Accounts List</h2>
<div class="select-container">
    <label for="items-per-page" id="label-for-page-count">Count per page:</label>
    <select id="items-per-page">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</div>

<table id="main-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<div class="pgn-container">
    <p class="pgn-text"> Pages:</p>
    <div id="pgn">
    </div>
</div>

<script>
    /**
     * @typedef {Object} Player
     * @property {number} id
     * @property {string} name
     * @property {string} title
     * @property {string} race
     * @property {string} profession
     * @property {string} birthday
     * @property {boolean} banned
     * @property {number} level
     */
    function loadPlayers(pageNumber, pageSize) {
        $.get('/rest/players', {pageNumber: pageNumber, pageSize: pageSize})
            .done(function (players) {
                const $tbody = $('#main-table tbody');
                $tbody.empty();

                if(players.length === 0) {
                    $tbody.append('<tr><td colspan="10">Нет игроков</td></tr>');
                    return;
                }

                players.forEach(function (player, index) {
                    const $tr = $('<tr>');
                    $tr.append($('<td>').text(index + 1 + (pageNumber * pageSize)));
                    $tr.append($('<td>').text(player.name));
                    $tr.append($('<td>').text(player.title));
                    $tr.append($('<td>').text(player.race));
                    $tr.append($('<td>').text(player.profession));
                    $tr.append($('<td>').text(player.level));
                    $tr.append($('<td>').text(new Date(player.birthday).toLocaleDateString()));
                    $tr.append($('<td>').text(player.banned ? 'Yes' : 'No'));

                    const $editBtn = $('<td>').addClass('table-img');
                    $editBtn.append($('<img alt="edit" src="/img/edit.png">'));
                    $tr.append($editBtn);

                    const $deleteBtn = $('<td>').addClass('table-img');
                    $deleteBtn.append($('<img alt="delete" src="/img/delete.png">'));
                    $tr.append($deleteBtn);

                    $tbody.append($tr);
                });
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Ошибка при загрузке игроков:', textStatus, errorThrown);
                alert('Не удалось загрузить данные с сервера.');
            });
    }

    $(document).ready(function () {
        const initialPageSize = 3;
        loadPlayers(0, initialPageSize);
        renderPagination(1, initialPageSize);
        $('#items-per-page').val(initialPageSize);
    });

    function getTotalCount() {
        return $.get('rest/players/count')
            .then(function (count) {
                return count;
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when getting total number of accounts', textStatus, errorThrown);
                alert('Failed to get total number of accounts');
                return 0;
            });
    }

    function renderPagination(currentPage, pageSize) {
        getTotalCount().then(function (totalCount) {
            const totalPages = Math.ceil(totalCount / pageSize);
            const $pagination = $('#pgn');
            $pagination.empty();

            for (let i = 1; i <= totalPages; i++) {
                const button = `<button class="page-btn" data-page="${i}">${i}</button>`;
                $pagination.append(button);
            }

            $('.page-btn[data-page="' + currentPage + '"]').addClass('active');

            $('.page-btn').click(function () {
                const page = $(this).data('page');
                loadPlayers(page - 1, pageSize);
                $('.page-btn').removeClass('active');
                $(this).addClass('active');
            })
        })
    }

    $('#items-per-page').change(function () {
        const pageSize = $(this).val();
        loadPlayers(0, pageSize);
        renderPagination(1, pageSize);
    })


</script>


</body>
</html>