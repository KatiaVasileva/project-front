<html lang="en">
<head>
    <title>RPG</title>
    <link rel="stylesheet" href="/css/my.css">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
</head>

<body>
<h1>RPG admin panel</h1>
<h2>Accounts List</h2>
<div class="select-container">
    <label for="items-per-page" id="label-for-page-count">Count per page:</label>
    <select id="items-per-page">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
    </select>
</div>

<table id="main-table">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>

<div class="pgn-container">
    <p class="pgn-text"> Pages:</p>
    <div id="pgn">
    </div>
</div>

<script>
    let currentPage = 0;
    let currentPageSize = 3;

    /**
     * @typedef {Object} Player
     * @property {number} id
     * @property {string} name
     * @property {string} title
     * @property {string} race
     * @property {string} profession
     * @property {string} birthday
     * @property {boolean} banned
     * @property {number} level
     */
    function loadPlayers(pageNumber, pageSize) {
        currentPage = pageNumber;
        currentPageSize = pageSize;

        $.get('/rest/players', {pageNumber: pageNumber, pageSize: pageSize})
            .done(function (players) {
                const $tbody = $('#main-table tbody');
                $tbody.empty();

                if(players.length === 0) {
                    $tbody.append('<tr><td colspan="10">Нет игроков</td></tr>');
                    return;
                }

                players.forEach(function (player) {
                    const $tr = $('<tr>');
                    $tr.append($('<td>').text(player.id));
                    $tr.append($('<td>').text(player.name));
                    $tr.append($('<td>').text(player.title));
                    $tr.append($('<td>').text(player.race));
                    $tr.append($('<td>').text(player.profession));
                    $tr.append($('<td>').text(player.level));
                    $tr.append($('<td>').text(new Date(player.birthday).toLocaleDateString()));
                    $tr.append($('<td>').text(player.banned ? 'Yes' : 'No'));

                    const $editBtn = $('<td>').addClass('table-img');
                    $editBtn.append($('<img>').attr({
                        src: '/img/edit.png',
                        alt: 'edit',
                        class: 'icon edit-icon',
                        'data-player-id': player.id,
                        'data-action': 'edit'
                    }));
                    $tr.append($editBtn);

                    const $deleteBtn = $('<td>').addClass('table-img');
                    $deleteBtn.append($('<img>').attr({
                        src: '/img/delete.png',
                        alt: 'delete',
                        class: 'icon delete-icon',
                        'data-player-id': player.id,
                        'data-action': 'delete'
                    }));
                    $tr.append($deleteBtn);

                    $tbody.append($tr);
                });
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when loading players:', textStatus, errorThrown);
                alert('Failed to load data from server.');
            });
    }

    $('#main-table').on('click', '.delete-icon', function () {
        const playerId = $(this).data('player-id');
        deletePlayer(playerId);
    })

    $(document).ready(function () {
        const $itemsPerPage = $('#items-per-page');

        $itemsPerPage.val(currentPageSize);
        loadPlayers(0, currentPageSize);
        renderPagination(currentPageSize);

        $itemsPerPage.on('change', function () {
            currentPageSize = +this.value;
            loadPlayers(0, currentPageSize);
            renderPagination(currentPageSize);
        });
    });

    function getTotalCount() {
        return $.get('rest/players/count')
            .then(function (count) {
                return count;
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
                console.error('Error when getting total number of accounts', textStatus, errorThrown);
                alert('Failed to get total number of accounts');
                return 0;
            });
    }

    function renderPagination(pageSize) {
        getTotalCount().then(function (totalCount) {
            const totalPages = Math.ceil(totalCount / pageSize);
            const $pagination = $('#pgn');
            $pagination.empty();

            for (let i = 1; i <= totalPages; i++) {
                $('.page-btn[data-page="1"]').addClass('active');
                const button = `<button class="page-btn" data-page="${i}">${i}</button>`;
                $pagination.append(button);
            }

            $('.page-btn[data-page="' + currentPage + '"]').addClass('active');

            $('.page-btn').click(function () {
                const page = $(this).data('page');
                loadPlayers(page - 1, pageSize);
                $('.page-btn').removeClass('active');
                $(this).addClass('active');
            })
        })
    }

    function deletePlayer(playerId) {
        $.ajax({
            url: `/rest/players/${playerId}`,
            type: 'DELETE',
            success: function () {
                console.log(`Player ID = ${playerId} is deleted`);
                loadPlayers(currentPage, currentPageSize);
                // renderPagination(currentPage, currentPageSize);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error('Error when deleting player: ', textStatus, errorThrown);
                alert('Failed to delete the player.');
            }
        })
    }

</script>

</body>
</html>